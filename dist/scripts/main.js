function UserServiceDelegate(){this.testUserData=[]}function DashboardController(){this.keyword="",this.hoveredNode=void 0,this.hoveredClientX=0,this.hoveredClientY=0,this.minR=50,this.rangeR=40,this.centerX=100,this.centerY=100,this.baseSize=20,this.SigmaGraph={},this.nodes=[],this.edges=[],this.expandedNodes=[],this.selectedNodes=[],this.endedNodes=[],this.normalColor="#ec5148",this.selectedColor="#00FF00",this.endColor="#DDDDDD",this.savedResult={}}function ConsoleController(){this.hosts=[{host:"52.8.90.3",name:"Nutch_01",status:"Unchecked"},{host:"52.8.208.245",name:"Nutch_02",status:"Unchecked"},{host:"52.8.101.101",name:"Nutch_dummy",status:"Unchecked"}],this.addDomainMsg="＜ドメインを追加する＞",this.apServer="52.8.36.62:6600",this.max_disp_lines=1e3,this.esServer="52.8.222.228:9200"}function TopController(){}var CustomEventManagerSingleton=function(){function e(){var e=new CustomEventManager;return e}var t;return{getInstance:function(){return t||(t=e()),t}}}(),CustomEventManager=function(){this.eventListnerMap={}};CustomEventManager.prototype.on=function(e,t){var n=this,o=n.eventListnerMap[e];o||(o=n.eventListnerMap[e]=[]),o.push(t)},CustomEventManager.prototype.emit=function(e,t){var n=this,o=n.eventListnerMap[e];$.each(o||[],function(n,o){o.func.apply(o.owner,{eventName:e,args:t})})};var ConcurrentManagerSingleton=function(){function e(){var e=new ConcurrentManager;return e}var t;return{getInstance:function(){return t||(t=e()),t}}}(),ConcurrentManager=function(){this.tasks={}};ConcurrentManager.prototype.asyncTask=function(e,t,n,o){var a=this,r=a.tasks[e];if(r){var s=$.Deferred();r.push(s);var i=function(){this.success=function(e){return s.then(e),this},this.error=function(){return this}};return new i}return r=[],a.tasks[e]=r,n.apply(t,o).success(function(t){$.each(r,function(e,n){n.resolve(t)}),a.tasks[e]=null})};var UtilManagerSingleton=function(){function e(){var e=new UtilManager;return e}var t;return{getInstance:function(){return t||(t=e()),t}}}(),UtilManager=function(){this.footers=[{text:"ホーム",iconClass:"ion-home",activeCss:"item-menu-active"},{text:"契約者情報",iconClass:"ion-compose",activeCss:""},{text:"調査案件",iconClass:"ion-levels",activeCss:""},{text:"調査報告",iconClass:"ion-speakerphone",activeCss:""},{text:"スケジュール",iconClass:"ion-clipboard",activeCss:""},{text:"マップ",iconClass:"ion-map",activeCss:""}],this.reportTypes=[{value:1,text:"事業対応"},{value:2,text:"定期訪問"},{value:3,text:"見積もり"}],this.responseTypes=[{value:1,text:"緊急"},{value:2,text:"通常"},{value:3,text:"余裕あり"}],this.jobEditMenus=[{index:1,label:"案件詳細",state:"assets/html/jobDetail/jobEdit/jobEditDetail.html",active:!1},{index:2,label:"事故情報",state:"",active:!1},{index:3,label:"医療調査",state:"assets/html/jobDetail/jobEdit/jobEditClinic.html",active:!1},{index:4,label:"連絡関連",state:"",active:!1},{index:5,label:"事案関連",state:"",active:!1},{index:6,label:"就労関連",state:"",active:!1},{index:7,label:"発注関連",state:"",active:!1}]};UtilManager.prototype.getDateString=function(e){var t=e.getFullYear()+"/";return t+=e.getMonth()+1>=10?e.getMonth()+1:"0"+(e.getMonth()+1),t+="/",t+=e.getDate()>=10?e.getDate():"0"+e.getDate()};var RestManagerSingleton=function(){function e(){var e=new RestManager;return e}var t;return{getInstance:function(){return t||(t=e()),t}}}(),RestManager=function(){this.controlParamKey=null,this.requestTime=0,this.responseTime=0,this.submitFlags={},this.delay=500};RestManager.prototype.loadingOn=function(){},RestManager.prototype.loadingOff=function(e){var t=this;e>t.delay||setTimeout(function(){},t.delay-e)},RestManager.prototype.ajaxErrorHandler=function(e,t){400===t?e.aina&&e.aina.status_CODE>50&&showMessage(e.aina):alert("サーバの呼び出しに失敗しました [http-status="+t+"]")},RestManager.prototype.doubleSubmitErrorHandler=function(){alert("通信中です")},RestManager.prototype.ajaxCall=function(e){var t=$.ajax(e),n=function(){this.success=function(e){return t.success(e),this},this.error=function(e){return t.error(e),this}};return new n},RestManager.prototype.send=function(e){function t(){n.submitFlags[e.url]="false",n.responseTime=(new Date).getTime();var t=n.responseTime-n.requestTime;n.loadingOff(t)}var n=this;if("true"===n.submitFlags[e.url])return void n.doubleSubmitErrorHandler();var o=e.data;return o||(o={},e.data=o),e.method=e.method||"POST",n.controlParamKey&&"POST"===e.type&&(o.controlParamKey=n.controlParamKey),n.submitFlags[e.url]="true",n.requestTime=(new Date).getTime(),n.loadingOn(),n.ajaxCall(e).success(function(){t()}).error(function(e,o){n.ajaxErrorHandler(e,o),t()})};var MockManagerSingleton=function(){function e(){var e=new MockManager;return e}var t;return{getInstance:function(){return t||(t=e()),t}}}(),MockManager=function(){};MockManager.prototype.createDefer=function(e,t){var n=t?t:$.Deferred(),o=n;return setTimeout(function(){t||n.resolve(e)},0),o.success=function(e){return o.then(function(t){e(t)}),this},o.error=function(e){return o.then(null,function(t){e(t)}),this},o};var UserServiceDelegateSingleton=function(){function e(){var e=new UserServiceDelegate;return e}var t;return{getInstance:function(){return t||(t=e()),t}}}();UserServiceDelegate.prototype.loadUsersData=function(){var e=this;return this.loadData("users.json").success(function(t){e.testUserData=t})},UserServiceDelegate.prototype.loadData=function(e){return RestManagerSingleton.getInstance().send({method:"GET",url:"scripts/services/test_data/"+e})},UserServiceDelegate.prototype.find=function(e){var t=parseInt(e),n=$.Deferred();return this.loadUsersData().success(function(e){for(var o=0;o<e.length;o++)e[o].id===t&&n.resolve(e[o])}),MockManagerSingleton.getInstance().createDefer(null,n)},UserServiceDelegate.prototype.selectAll=function(){return this.loadUsersData()};var RootScopeSingleton=function(){function e(){var e=new RootScope;return e}var t;return{getInstance:function(){return t||(t=e()),t}}}(),RootScope=function(){this.selectedJob=null};$(document).ready(function(){$("#root").load("assets/html/dashboard/top.html",function(){console.log("load dashboard")})}),DashboardController.prototype.onOverNode=function(e){var t=this;t.hoveredNode=e.data.node,t.hoveredClientX=e.data.captor.clientX,t.hoveredClientY=e.data.captor.clientY,t.isExpanded(t.hoveredNode.label)||($("#expandBtn").css("left",e.data.captor.clientX+10),$("#expandBtn").css("top",e.data.captor.clientY+10),$("#expandBtn").show())},DashboardController.prototype.onOutNode=function(){},DashboardController.prototype.selectNode=function(e){var t=this;t.selectedNodes.push(e),e.color=t.selectedColor,t.SigmaGraph.refresh(),t.dispRelatives()},DashboardController.prototype.unselectNode=function(e){for(var t=this,n=0;n<t.selectedNodes.length;n++)void 0!=t.selectedNodes[n]&&e.label===t.selectedNodes[n].label&&(t.selectedNodes[n]=void 0);e.color=t.isEnded(e.label)?t.endColor:t.normalColor,t.SigmaGraph.refresh(),t.dispRelatives()},DashboardController.prototype.dispRelatives=function(){for(var e=this,t="",n=0,o=0;o<e.selectedNodes.length;o++)void 0!==e.selectedNodes[o]&&(t+=0===n?e.selectedNodes[o].label:", "+e.selectedNodes[o].label,n++);$("#divRelative").text(t)},DashboardController.prototype.onClickNode=function(e){var t=this;t.hoveredNode=e.data.node,t.hoveredClientX=e.data.captor.clientX,t.hoveredClientY=e.data.captor.clientY,t.isSelected(e.data.node.label)?t.unselectNode(e.data.node):t.selectNode(e.data.node)},DashboardController.prototype.save=function(){var e=this;e.savedResult={nodes:e.SigmaGraph.graph.nodes(),edges:e.SigmaGraph.graph.edges(),selected:this.selectedNodes,keyword:this.keyword}},DashboardController.prototype.load=function(){var e=this;e.SigmaGraph.graph.clear(),$.each(e.savedResult.nodes,function(t,n){e.SigmaGraph.graph.addNode(n)}),$.each(e.savedResult.edges,function(t,n){e.SigmaGraph.graph.addEdge(n)}),e.selectedNodes=e.savedResult.selected,e.dispRelatives(),e.keyword=e.savedResult.keyword,$("#keyword").val(e.keyword),e.SigmaGraph.refresh()},DashboardController.prototype.init=function(){var e=this;e.SigmaGraph=new sigma({graph:{nodes:[],edges:[]}}),e.SigmaGraph.settings({labelThreshold:1}),e.SigmaGraph.addCamera("cam1"),e.SigmaGraph.addRenderer({container:document.getElementById("divSigma"),type:"canvas",camera:"cam1"}),sigma.renderers.def=sigma.renderers.canvas,sigma.plugins.dragNodes(e.SigmaGraph,e.SigmaGraph.renderers[0]),e.SigmaGraph.bind("overNode",function(t){e.onOverNode(t)}),e.SigmaGraph.bind("outNode",function(t){e.onOutNode(t)}),e.SigmaGraph.bind("clickNode",function(t){e.onClickNode(t)}),$("#btnFetchKeys").on("click",function(){e.search()}),$("#expandBtn").on("click",function(){e.expand()}),$("#btnFinalSearch").on("click",function(){e.keyword=$("#keyword").val();var t=[e.keyword];$.each(e.selectedNodes,function(e,n){void 0!=n&&t.push(n.label)}),$("#resultWindow").empty(),$("#resultCount").empty(),$("#siteWindow").empty(),$("#siteCount").empty(),e.getResults(t).success(function(n){$("#resultCount").text("検索結果："+n.hits.total+"件。（下記は関連度Top10）");var o=n.hits.hits,a="<div class='resultItem'><a href='${url}' target='_blank_'>${url}</a><span>{{html summary}}</span></div>";$.template("resultList",a);for(var r=[],s=0;s<o.length;s++){var i=o[s];if(s>=10)break;var d={};d.url=i._id,d.summary="";for(var l=0;l<i.highlight.content.length&&(d.summary+="......"+i.highlight.content[l]+"...... ",!(l>3));l++);r.push(d)}$.tmpl("resultList",r).appendTo("#resultWindow"),e.getScores(t).success(function(t){var n=e.getTop(10,t.hits.hits);if(n instanceof Array&&!(n.length<1)){var o="<div class='siteItem'><a href='${url}' target='_blank_'>${url}</a><span>Score:${score}</span></div>";$.template("siteList",o),$.tmpl("siteList",n).appendTo("#siteWindow"),$("#siteCount").text("関連サイト："+n.length+"個。（下記は関連度Top10）")}})})}),$("#divSigma").on("mousemove",function(t){e.onMouseMove(t)}),$("#expandBtn").css("position","absolute"),$("#expandBtn").hide(),$("#switchBtnL").on("click",function(){$("#topdiv")[0].className="app-container row row-100 horizontal-slider slide-100"}),$("#btnSave").on("click",function(){e.save()}),$("#btnLoad").on("click",function(){e.load()})},DashboardController.prototype.getTop=function(e,t){var n=this;if(t instanceof Array){t.sort(function(e,t){return e._id==t._id?0:e._id<t._id?-1:1});var o=[],a=n.getWebsiteName(t[0]._id),r="",s=0,i=function(){var t=Math.round(1e3*s)/1e3;o.length<e?(o.push({url:a,score:t}),o.length===e&&o.sort(function(e,t){return e.score==t.score?0:e.score<t.score?1:-1})):n.insertData(o,a,t)};return $.each(t,function(e,t){r=n.getWebsiteName(t._id),a===r?t._score>0&&(s+=t._score):(i(),a=r,s=t._score)}),i(),o.length<e&&o.sort(function(e,t){return e.score==t.score?0:e.score<t.score?1:-1}),o}},DashboardController.prototype.getWebsiteName=function(e){var t=/(http|https):\/\/([a-z0-9]*\.)*[a-z0-9]+(:[0-9]{1,4})?\//.exec(e);return t instanceof Array&&t.length>0?t[0]:""},DashboardController.prototype.insertData=function(e,t,n){if(e instanceof Array&&!(e.length<1)){var o=-1,a=e[0];if(!(a.score>=n)){if($.each(e,function(e,t){n>t.score&&(o=e)}),0==o)return a.url=t,void(a.score=n);var r="",s=0;for(i=o;i>0;i--)a=e[i],r=a.url,s=a.score,a=e[i-1],a.url=r,a.score=s;a=e[o],a.url=t,a.score=n}}},DashboardController.prototype.onMouseMove=function(e){var t=this;void 0!==t.hoveredNode&&65<t.calcDistance(t.hoveredClientX,t.hoveredClientY,e.clientX,e.clientY)&&($("#expandBtn").hide(),t.hoveredNode=void 0)},DashboardController.prototype.calcDistance=function(e,t,n,o){var a=n-e,r=o-t;return Math.sqrt(a*a+r*r)},DashboardController.prototype.isExpanded=function(e){for(var t=this,n=0;n<t.expandedNodes.length;n++)if(e===t.expandedNodes[n].label)return!0;return!1},DashboardController.prototype.isEnded=function(e){for(var t=this,n=0;n<t.endedNodes.length;n++)if(e===t.endedNodes[n].label)return!0;return!1},DashboardController.prototype.isSelected=function(e){for(var t=this,n=0;n<t.selectedNodes.length;n++)if(void 0!=t.selectedNodes[n]&&e===t.selectedNodes[n].label)return!0;return!1},DashboardController.prototype.expand=function(){var e=this;e.isExpanded(e.hoveredNode.label)||e.getTerms(e.hoveredNode.label).success(function(t){0===t.aggregations.most_sig.buckets.length?(e.isSelected(e.hoveredNode.label)||(e.hoveredNode.color=e.endColor),e.endedNodes.push(e.hoveredNode)):e.addNodes(e.hoveredNode,t.aggregations.most_sig.buckets),e.SigmaGraph.refresh(),$("#expandBtn").hide(),e.expandedNodes.push(e.hoveredNode)})},DashboardController.prototype.getResults=function(e){return RestManagerSingleton.getInstance().send({method:"POST",url:"http://52.8.222.228:9200/demo/_search?pretty=true ",data:'{"query": {"terms" : { "content" : '+JSON.stringify(e)+'} }, "size": 10, "highlight" : {"fields" : {"content" : {}}}}'})},DashboardController.prototype.getScores=function(e){return RestManagerSingleton.getInstance().send({method:"POST",url:"http://52.8.222.228:9200/demo/_search?pretty=true ",data:'{"fields":["id","score"], "query": {"terms" : { "content" : '+JSON.stringify(e)+'} }, "size": 1000 }'})},DashboardController.prototype.getTerms=function(e){return RestManagerSingleton.getInstance().send({method:"POST",url:"http://52.8.222.228:9200/demo/_search?search_type=count&pretty=true ",data:'{"query": {"term" : { "content" : "'+e+'"} }, "size": 0, "aggs": {   "most_sig": {     "significant_terms": {        "field": "content",       "size": 16}}}}'})},DashboardController.prototype.findNode=function(e){for(var t=this,n=0;n<t.nodes.length;n++)if(e===t.nodes[n].label)return t.nodes[n];return void 0},DashboardController.prototype.findEdge=function(e,t){for(var n=this,o=0;o<n.edges.length;o++)if(e===n.edges[o].source&&t===n.edges[o].target||t===n.edges[o].source&&e===n.edges[o].target)return n.edges[o];return void 0},DashboardController.prototype.addNodes=function(e,t){var n,o,a,r,s=this;void 0===e?(e={id:"n0",label:s.keyword,x:s.centerX,y:s.centerY,size:8*s.baseSize,color:s.normalColor},s.SigmaGraph.graph.addNode(e),s.nodes.push(e),s.expandedNodes.push(e),n=s.centerX,o=s.centerY,a="n",r="e"):(n=e.x,o=e.y,a=e.id+"_",r="e_"+e.id+"_");for(var i=t.length,d=360/i*Math.PI/180,l=0;l<t.length;l++)if(e.label!==t[l].key){var c=s.findNode(t[l].key);if(void 0==c){var u=Math.random()*s.rangeR+s.minR,h={id:a+(l+1),label:t[l].key,x:n+Math.cos(l*d)*u,y:o+Math.sin(l*d)*u,size:s.baseSize*t[l].score*2,color:s.normalColor};s.nodes.push(h),s.SigmaGraph.graph.addNode(h);var p={id:r+l,source:e.id,target:a+(l+1),size:3,color:s.normalColor};s.edges.push(p),s.SigmaGraph.graph.addEdge(p)}else{var g=s.findEdge(c.id,e.id);void 0===g&&s.SigmaGraph.graph.addEdge({id:r+l,source:e.id,target:c.id,size:3,color:s.normalColor})}}},DashboardController.prototype.search=function(){var e=this;e.keyword=$("#keyword").val(),e.getTerms(e.keyword).success(function(t){e.SigmaGraph.graph.clear(),e.nodes=[],e.edges=[],e.expandedNodes=[],e.selectedNodes=[],e.endedNodes=[],e.addNodes(void 0,t.aggregations.most_sig.buckets),e.SigmaGraph.refresh(),e.dispRelatives()})},ConsoleController.prototype.init=function(){var e=this,t="<div id='i_${tag}' class='hostItem'><span class='hostName'>Node : ${tag}</span>";t+="<span class='hostIP'>${ip}</span>",t+="<span id='h_${tag}' class='hostStatus'>${status}</span>",t+="<span id='b_${tag}' class='hostButton'>Check</span>",t+="<span id='v_${tag}' class='hostButton'>View>></span></div>",$.template("hostList",t);var n=[];$.each(e.hosts,function(e,t){var o={};o.tag=t.name,o.ip=t.host,o.status=t.status,n.push(o)}),$.tmpl("hostList",n).appendTo("#hostlist"),$.each(n,function(t,n){$("#b_"+n.tag).on("click",function(){$("#h_"+n.tag).text("checking..."),e.checkStatus(n)}),$("#v_"+n.tag).on("click",function(){e.getStatics(n)})}),$("#btnTest").on("click",function(){e.search()}),$("#editDomainDiv1").hide(),$("#editDomainDiv2").hide(),$("#crawlstats").hide(),$("#domains").hide(),$("#divcompare").hide(),$("#divbefore").text("--"),$("#divafter").text("--"),$("#editDomain").val(""),$("#editTopN").val(20),$("#switchBtnR").on("click",function(){$("#topdiv")[0].className="app-container row row-100 horizontal-slider"})},ConsoleController.prototype.checkStatus=function(e){var t=this;RestManagerSingleton.getInstance().send({method:"POST",url:"http://"+t.apServer+"/check",data:{host:e.ip}}).success(function(t){$("#h_"+e.tag).text(JSON.parse(t).status)})},ConsoleController.prototype.getStatics=function(e){var t=this;$("#crawlstats").empty(),$("#domains").empty(),$("#h_"+e.tag).text("opening..."),$("#editDomain").val(""),$("#divbefore").text("--"),$("#divafter").text("--"),RestManagerSingleton.getInstance().send({method:"POST",url:"http://"+t.apServer+"/stats",data:{host:e.ip}}).success(function(n){var o=JSON.parse(n);if($("#h_"+e.tag).text(JSON.parse(n).status),$("#startCrawl").off("click"),"error"!=JSON.parse(n).status){$("#editDomainDiv1").show(),$("#editDomainDiv2").show(),$("#crawlstats").show(),$("#domains").show(),$("#divcompare").show(),$.template("statList","<span class='crawlstat'>${stat}</span>");var a=[];$.each(o.statics,function(e,t){a.push({stat:t})}),$.tmpl("statList",a).appendTo("#crawlstats"),o.domains.push(t.addDomainMsg),$.template("domainList","<span id='d_${idx}' class='domainspan'>${domain}</span>");var r=[];$.each(o.domains,function(e,t){r.push({domain:t,idx:e})}),$.tmpl("domainList",r).appendTo("#domains");var s=function(e){var n=e.data.d,o={domain:t.addDomainMsg,idx:r.length};n.domain=$("#editDomain").val().replace("\r",""),$("#d_"+n.idx).text(n.domain),r.push(o),$.template("domainList","<span id='d_${idx}' class='domainspan'>${domain}</span>"),$.tmpl("domainList",[o]).appendTo("#domains"),$("#d_"+o.idx).on("click",{d:o},l),$("#applyDomain").off("click"),$("#applyDomain").on("click",{d:o},s)},i=function(e){e.data.d.domain=$("#editDomain").val().replace("\r",""),$("#d_"+e.data.d.idx).text(e.data.d.domain)},d=function(e){r.splice(r.indexOf(e.data.d),1),document.getElementById("domains").removeChild(document.getElementById("d_"+e.data.d.idx)),$("#deleteDomain").off("click"),$("#editDomain").val("")},l=function(e){var n=e.data.d;$("#applyDomain").off("click"),$("#deleteDomain").off("click"),n.domain===t.addDomainMsg?($("#editDomain").val(""),$("#applyDomain").text("追加"),$("#applyDomain").on("click",{d:n},s)):($("#editDomain").val(n.domain),$("#applyDomain").text("更新"),$("#applyDomain").on("click",{d:n},i),$("#deleteDomain").on("click",{d:n},d)),$("#editDomain").focus()};$.each(r,function(e,t){$("#d_"+t.idx).on("click",{d:t},l)}),$("#applyDomain").on("click",{d:r[r.length-1]},s),$("#confirmDomains").off("click"),$("#confirmDomains").on("click",{l:r},function(){r[r.length-1].domain===t.addDomainMsg&&r.pop(),t.confirmDomains(e,r)}),$("#startCrawl").on("click",{h:e},function(e){t.startCrawl(e.data.h,$("#editTopN").val())})}})},ConsoleController.prototype.confirmDomains=function(e,t){var n=this;$("#h_"+e.tag).text("config..."),RestManagerSingleton.getInstance().send({method:"POST",url:"http://"+n.apServer+"/modify",data:{host:e.ip,domains:JSON.stringify(t)}}).success(function(t){$("#h_"+e.tag).text(JSON.parse(t).status),n.getStatics(e)})},ConsoleController.prototype.startCrawl=function(e,t){var n=this;$("#divbefore").text("--"),$("#divafter").text("--"),n.getIndexAmount().success(function(o){$("#divbefore").text(o.hits.total),RestManagerSingleton.getInstance().send({method:"POST",url:"http://"+n.apServer+"/start",data:{host:e.ip,topN:t}}).success(function(t){$("#h_"+e.tag).text(JSON.parse(t).status),setTimeout(function(){n.displayCrawl(e)},200)})})},ConsoleController.prototype.getIndexAmount=function(){var e=this;return RestManagerSingleton.getInstance().send({method:"POST",url:"http://"+e.esServer+"/demo/_search?search_type=count&pretty=true",data:'{"query": {"matchAll" : {} }, "size": 0}'})},ConsoleController.prototype.displayCrawl=function(e){var t=this;RestManagerSingleton.getInstance().send({method:"POST",url:"http://"+t.apServer+"/display",data:{host:e.ip}}).success(function(n){var o=JSON.parse(n);$("#h_"+e.tag).text(o.status),$("#progress").empty(),$.template("prog","<span class='progressItem'>${name} ${stats}</span>"),$.tmpl("prog",o.progress.stages).appendTo("#progress"),"finished"===o.status?t.getIndexAmount().success(function(e){$("#divafter").text(e.hits.total)}):setTimeout(function(){t.displayCrawl(e)},500)})},TopController.prototype.init=function(){$("#dashboard").load("assets/html/dashboard/dashboard.html",function(){}),$("#console").load("assets/html/dashboard/console.html",function(){})};