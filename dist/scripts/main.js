function UserServiceDelegate(){this.testUserData=[]}function DashboardController(){this.keyword="",this.hoveredNode=void 0,this.hoveredClientX=0,this.hoveredClientY=0,this.minR=50,this.rangeR=40,this.centerX=100,this.centerY=100,this.baseSize=20,this.SigmaGraph={},this.nodes=[],this.edges=[],this.expandedNodes=[],this.selectedNodes=[],this.endedNodes=[],this.normalColor="#ec5148",this.selectedColor="#00FF00",this.endColor="#DDDDDD"}var CustomEventManagerSingleton=function(){function e(){var e=new CustomEventManager;return e}var t;return{getInstance:function(){return t||(t=e()),t}}}(),CustomEventManager=function(){this.eventListnerMap={}};CustomEventManager.prototype.on=function(e,t){var n=this,r=n.eventListnerMap[e];r||(r=n.eventListnerMap[e]=[]),r.push(t)},CustomEventManager.prototype.emit=function(e,t){var n=this,r=n.eventListnerMap[e];$.each(r||[],function(n,r){r.func.apply(r.owner,{eventName:e,args:t})})};var ConcurrentManagerSingleton=function(){function e(){var e=new ConcurrentManager;return e}var t;return{getInstance:function(){return t||(t=e()),t}}}(),ConcurrentManager=function(){this.tasks={}};ConcurrentManager.prototype.asyncTask=function(e,t,n,r){var o=this,a=o.tasks[e];if(a){var s=$.Deferred();a.push(s);var i=function(){this.success=function(e){return s.then(e),this},this.error=function(){return this}};return new i}return a=[],o.tasks[e]=a,n.apply(t,r).success(function(t){$.each(a,function(e,n){n.resolve(t)}),o.tasks[e]=null})};var UtilManagerSingleton=function(){function e(){var e=new UtilManager;return e}var t;return{getInstance:function(){return t||(t=e()),t}}}(),UtilManager=function(){this.footers=[{text:"ホーム",iconClass:"ion-home",activeCss:"item-menu-active"},{text:"契約者情報",iconClass:"ion-compose",activeCss:""},{text:"調査案件",iconClass:"ion-levels",activeCss:""},{text:"調査報告",iconClass:"ion-speakerphone",activeCss:""},{text:"スケジュール",iconClass:"ion-clipboard",activeCss:""},{text:"マップ",iconClass:"ion-map",activeCss:""}],this.reportTypes=[{value:1,text:"事業対応"},{value:2,text:"定期訪問"},{value:3,text:"見積もり"}],this.responseTypes=[{value:1,text:"緊急"},{value:2,text:"通常"},{value:3,text:"余裕あり"}],this.jobEditMenus=[{index:1,label:"案件詳細",state:"assets/html/jobDetail/jobEdit/jobEditDetail.html",active:!1},{index:2,label:"事故情報",state:"",active:!1},{index:3,label:"医療調査",state:"assets/html/jobDetail/jobEdit/jobEditClinic.html",active:!1},{index:4,label:"連絡関連",state:"",active:!1},{index:5,label:"事案関連",state:"",active:!1},{index:6,label:"就労関連",state:"",active:!1},{index:7,label:"発注関連",state:"",active:!1}]};UtilManager.prototype.getDateString=function(e){var t=e.getFullYear()+"/";return t+=e.getMonth()+1>=10?e.getMonth()+1:"0"+(e.getMonth()+1),t+="/",t+=e.getDate()>=10?e.getDate():"0"+e.getDate()};var RestManagerSingleton=function(){function e(){var e=new RestManager;return e}var t;return{getInstance:function(){return t||(t=e()),t}}}(),RestManager=function(){this.controlParamKey=null,this.requestTime=0,this.responseTime=0,this.submitFlags={},this.delay=500};RestManager.prototype.loadingOn=function(){},RestManager.prototype.loadingOff=function(e){var t=this;e>t.delay||setTimeout(function(){},t.delay-e)},RestManager.prototype.ajaxErrorHandler=function(e,t){400===t?e.aina&&e.aina.status_CODE>50&&showMessage(e.aina):alert("サーバの呼び出しに失敗しました [http-status="+t+"]")},RestManager.prototype.doubleSubmitErrorHandler=function(){alert("通信中です")},RestManager.prototype.ajaxCall=function(e){var t=$.ajax(e),n=function(){this.success=function(e){return t.success(e),this},this.error=function(e){return t.error(e),this}};return new n},RestManager.prototype.send=function(e){function t(){n.submitFlags[e.url]="false",n.responseTime=(new Date).getTime();var t=n.responseTime-n.requestTime;n.loadingOff(t)}var n=this;if("true"===n.submitFlags[e.url])return void n.doubleSubmitErrorHandler();var r=e.data;return r||(r={},e.data=r),e.method=e.method||"POST",n.controlParamKey&&"POST"===e.type&&(r.controlParamKey=n.controlParamKey),n.submitFlags[e.url]="true",n.requestTime=(new Date).getTime(),n.loadingOn(),n.ajaxCall(e).success(function(){t()}).error(function(e,r){n.ajaxErrorHandler(e,r),t()})};var MockManagerSingleton=function(){function e(){var e=new MockManager;return e}var t;return{getInstance:function(){return t||(t=e()),t}}}(),MockManager=function(){};MockManager.prototype.createDefer=function(e,t){var n=t?t:$.Deferred(),r=n;return setTimeout(function(){t||n.resolve(e)},0),r.success=function(e){return r.then(function(t){e(t)}),this},r.error=function(e){return r.then(null,function(t){e(t)}),this},r};var UserServiceDelegateSingleton=function(){function e(){var e=new UserServiceDelegate;return e}var t;return{getInstance:function(){return t||(t=e()),t}}}();UserServiceDelegate.prototype.loadUsersData=function(){var e=this;return this.loadData("users.json").success(function(t){e.testUserData=t})},UserServiceDelegate.prototype.loadData=function(e){return RestManagerSingleton.getInstance().send({method:"GET",url:"scripts/services/test_data/"+e})},UserServiceDelegate.prototype.find=function(e){var t=parseInt(e),n=$.Deferred();return this.loadUsersData().success(function(e){for(var r=0;r<e.length;r++)e[r].id===t&&n.resolve(e[r])}),MockManagerSingleton.getInstance().createDefer(null,n)},UserServiceDelegate.prototype.selectAll=function(){return this.loadUsersData()};var RootScopeSingleton=function(){function e(){var e=new RootScope;return e}var t;return{getInstance:function(){return t||(t=e()),t}}}(),RootScope=function(){this.selectedJob=null};$(document).ready(function(){$("#root").load("assets/html/dashboard/dashboard.html",function(){console.log("load dashboard")})}),DashboardController.prototype.onOverNode=function(e){var t=this;t.hoveredNode=e.data.node,t.hoveredClientX=e.data.captor.clientX,t.hoveredClientY=e.data.captor.clientY,t.isExpanded(t.hoveredNode.label)||($("#expandBtn").css("left",e.data.captor.clientX+10),$("#expandBtn").css("top",e.data.captor.clientY+10),$("#expandBtn").show())},DashboardController.prototype.onOutNode=function(){},DashboardController.prototype.selectNode=function(e){var t=this;t.selectedNodes.push(e),e.color=t.selectedColor,t.SigmaGraph.refresh(),t.dispRelatives()},DashboardController.prototype.unselectNode=function(e){for(var t=this,n=0;n<t.selectedNodes.length;n++)void 0!=t.selectedNodes[n]&&e.label===t.selectedNodes[n].label&&(t.selectedNodes[n]=void 0);e.color=t.isEnded(e.label)?t.endColor:t.normalColor,t.SigmaGraph.refresh(),t.dispRelatives()},DashboardController.prototype.dispRelatives=function(){for(var e=this,t="",n=0,r=0;r<e.selectedNodes.length;r++)void 0!==e.selectedNodes[r]&&(t+=0===n?e.selectedNodes[r].label:", "+e.selectedNodes[r].label,n++);$("#divRelative").text(t)},DashboardController.prototype.onClickNode=function(e){var t=this;t.hoveredNode=e.data.node,t.hoveredClientX=e.data.captor.clientX,t.hoveredClientY=e.data.captor.clientY,t.isSelected(e.data.node.label)?t.unselectNode(e.data.node):t.selectNode(e.data.node)},DashboardController.prototype.init=function(){var e=this;e.SigmaGraph=new sigma({graph:{nodes:[],edges:[]}}),e.SigmaGraph.settings({labelThreshold:1}),e.SigmaGraph.addCamera("cam1"),e.SigmaGraph.addRenderer({container:document.getElementById("divSigma"),type:"canvas",camera:"cam1"}),sigma.renderers.def=sigma.renderers.canvas,sigma.plugins.dragNodes(e.SigmaGraph,e.SigmaGraph.renderers[0]),e.SigmaGraph.bind("overNode",function(t){e.onOverNode(t)}),e.SigmaGraph.bind("outNode",function(t){e.onOutNode(t)}),e.SigmaGraph.bind("clickNode",function(t){e.onClickNode(t)}),$("#btnFetchKeys").on("click",function(){e.search()}),$("#expandBtn").on("click",function(){e.expand()}),$("#btnFinalSearch").on("click",function(){e.keyword=$("#keyword").val();var t=[e.keyword];$.each(e.selectedNodes,function(e,n){void 0!=n&&t.push(n.label)}),$("#resultWindow").empty(),$("#resultCount").empty(),e.getResults(t).success(function(e){$("#resultCount").text("検索結果：　"+e.hits.total+"件。　（下記はTop10）");var t=e.hits.hits,n="<div class='resultItem'><a href='${url}' target='_blank_'>${url}</a><span>{{html summary}}</span></div>";$.template("resultList",n);var r=[];$.each(t,function(e,t){var n={};n.url=t._id,n.summary="";for(var o=0;o<t.highlight.content.length&&(n.summary+="......"+t.highlight.content[o]+"...... ",!(o>3));o++);r.push(n)}),$.tmpl("resultList",r).appendTo("#resultWindow")})}),$("#divSigma").on("mousemove",function(t){e.onMouseMove(t)}),$("#expandBtn").css("position","absolute"),$("#expandBtn").hide()},DashboardController.prototype.onMouseMove=function(e){var t=this;void 0!==t.hoveredNode&&65<t.calcDistance(t.hoveredClientX,t.hoveredClientY,e.clientX,e.clientY)&&($("#expandBtn").hide(),t.hoveredNode=void 0)},DashboardController.prototype.calcDistance=function(e,t,n,r){var o=n-e,a=r-t;return Math.sqrt(o*o+a*a)},DashboardController.prototype.isExpanded=function(e){for(var t=this,n=0;n<t.expandedNodes.length;n++)if(e===t.expandedNodes[n].label)return!0;return!1},DashboardController.prototype.isEnded=function(e){for(var t=this,n=0;n<t.endedNodes.length;n++)if(e===t.endedNodes[n].label)return!0;return!1},DashboardController.prototype.isSelected=function(e){for(var t=this,n=0;n<t.selectedNodes.length;n++)if(void 0!=t.selectedNodes[n]&&e===t.selectedNodes[n].label)return!0;return!1},DashboardController.prototype.expand=function(){var e=this;e.isExpanded(e.hoveredNode.label)||e.getTerms(e.hoveredNode.label).success(function(t){0===t.aggregations.most_sig.buckets.length?(e.isSelected(e.hoveredNode.label)||(e.hoveredNode.color=e.endColor),e.endedNodes.push(e.hoveredNode)):e.addNodes(e.hoveredNode,t.aggregations.most_sig.buckets),e.SigmaGraph.refresh(),$("#expandBtn").hide(),e.expandedNodes.push(e.hoveredNode)})},DashboardController.prototype.getResults=function(e){return RestManagerSingleton.getInstance().send({method:"POST",url:"http://52.8.222.228:9200/demo/_search?pretty=true ",data:'{"query": {"terms" : { "content" : '+JSON.stringify(e)+'} }, "size": 10, "highlight" : {"fields" : {"content" : {}}}}'})},DashboardController.prototype.getTerms=function(e){return RestManagerSingleton.getInstance().send({method:"POST",url:"http://52.8.222.228:9200/demo/_search?search_type=count&pretty=true ",data:'{"query": {"term" : { "content" : "'+e+'"} }, "size": 0, "aggs": {   "most_sig": {     "significant_terms": {        "field": "content",       "size": 16}}}}'})},DashboardController.prototype.findNode=function(e){for(var t=this,n=0;n<t.nodes.length;n++)if(e===t.nodes[n].label)return t.nodes[n];return void 0},DashboardController.prototype.findEdge=function(e,t){for(var n=this,r=0;r<n.edges.length;r++)if(e===n.edges[r].source&&t===n.edges[r].target||t===n.edges[r].source&&e===n.edges[r].target)return n.edges[r];return void 0},DashboardController.prototype.addNodes=function(e,t){var n,r,o,a,s=this;void 0===e?(e={id:"n0",label:s.keyword,x:s.centerX,y:s.centerY,size:8*s.baseSize,color:s.normalColor},s.SigmaGraph.graph.addNode(e),s.nodes.push(e),s.expandedNodes.push(e),n=s.centerX,r=s.centerY,o="n",a="e"):(n=e.x,r=e.y,o=e.id+"_",a="e_"+e.id+"_");for(var i=t.length,d=360/i*Math.PI/180,l=0;l<t.length;l++)if(e.label!==t[l].key){var c=s.findNode(t[l].key);if(void 0==c){var u=Math.random()*s.rangeR+s.minR,h={id:o+(l+1),label:t[l].key,x:n+Math.cos(l*d)*u,y:r+Math.sin(l*d)*u,size:s.baseSize*t[l].score*2,color:s.normalColor};s.nodes.push(h),s.SigmaGraph.graph.addNode(h);var p={id:a+l,source:e.id,target:o+(l+1),size:3,color:s.normalColor};s.edges.push(p),s.SigmaGraph.graph.addEdge(p)}else{var g=s.findEdge(c.id,e.id);void 0===g&&s.SigmaGraph.graph.addEdge({id:a+l,source:e.id,target:c.id,size:3,color:s.normalColor})}}},DashboardController.prototype.search=function(){var e=this;e.keyword=$("#keyword").val(),e.getTerms(e.keyword).success(function(t){e.SigmaGraph.graph.clear(),e.nodes=[],e.edges=[],e.expandedNodes=[],e.selectedNodes=[],e.endedNodes=[],e.addNodes(void 0,t.aggregations.most_sig.buckets),e.SigmaGraph.refresh(),e.dispRelatives()})};